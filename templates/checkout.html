<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - FestaClub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="/static/firebase.js"></script>
</head>
<body>

    <header>
        <div class="logo">
        <a href="/">
            <img src="/static/IMG_2751.jpg" alt="Logo RZ Produções">
        </a>
    </div>
        <nav>
            <a href="/">Home</a>
            <a href="/eventos">Eventos</a>
        </nav>

        <div class="acoes-header">
        <a href="/login" class="btn-acesso">Entrar</a>
    </div>
    </header>

    <main>
        <section class="secao-contato" style="padding-top: 120px;">
            <h1>Finalizar Pagamento</h1>
            
            <div class="contato-grid">
                
                <!-- ESTADO 1: Resumo do Pedido e Dados -->
                <div id="card-resumo" class="contato-info" style="width: 100%; max-width: 500px; text-align: left;">
                    <h2 style="color: var(--cor-secundaria);">Festa 0800 - Edição Verão</h2>
                    <p><i class="fas fa-map-marker-alt"></i> Blue Center, Rio de Janeiro</p>
                    <hr style="border-color: #333; margin: 15px 0;">
                    
                    <!-- CAMPOS NOVOS PARA O USUÁRIO PREENCHER -->
                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom: 5px; color: #ccc;">Seu Nome:</label>
                        <input type="text" id="nome_pagador" placeholder="Primeiro Nome" style="width: 48%; padding: 10px; background: #000; color: #fff; border: 1px solid #333; border-radius: 5px;">
                        <input type="text" id="sobrenome_pagador" placeholder="Sobrenome" style="width: 48%; padding: 10px; background: #000; color: #fff; border: 1px solid #333; border-radius: 5px;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display:block; margin-bottom: 5px; color: #ccc;">CPF do Pagador:</label>
                        <input type="text" id="cpf_pagador" placeholder="Apenas números (Ex: 12345678900)" maxlength="11" style="width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #333; border-radius: 5px;">
                        <small style="color: #666; font-size: 11px;">Necessário para gerar o PIX.</small>
                    </div>

                    <label style="display:block; margin-bottom: 5px; color: #ccc;">Quantidade:</label>
                    <select id="qtd" style="width: 100%; padding: 10px; background: #000; color: #fff; border: 1px solid #333; border-radius: 5px;">
                        <option value="1">1 Ingresso (R$ 50,00)</option>
                        <option value="2">2 Ingressos (R$ 100,00)</option>
                        <option value="3">3 Ingressos (R$ 150,00)</option>
                    </select>

                    <h3 id="totalDisplay" style="margin-top: 20px; font-size: 24px;">Total: R$ 50,00</h3>

                    <button id="btn-pagar" onclick="gerarPix()" class="btn-compre-agora" style="width: 100%; margin-top: 20px;">
                        PAGAR COM PIX
                    </button>
                    
                    <p id="msgErro" style="color: red; margin-top: 10px; text-align: center; display: none;"></p>
                    <p id="loading" style="color: yellow; margin-top: 10px; text-align: center; display: none;">Gerando Código PIX...</p>
                </div>

                <!-- ESTADO 2: Área do PIX (Apenas Copia e Cola) -->
                <div id="card-pix" class="contato-info" style="width: 100%; max-width: 500px; text-align: center; display: none;">
                    <h2 style="color: #00bd20; margin-bottom: 20px;">Pagamento Gerado!</h2>
                    
                    <p style="margin-bottom: 10px; color: #ccc;">Copie o código abaixo e cole no app do seu banco na opção <strong>"PIX Copia e Cola"</strong>:</p>
                    
                    <div style="background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #555;">
                        <textarea id="cola-pix" rows="4" style="width: 100%; font-size: 13px; color: #fff; background: transparent; border: none; resize: none; word-break: break-all;" readonly></textarea>
                    </div>

                    <button onclick="copiarPix()" style="background: var(--cor-secundaria); color: #000; border: none; padding: 10px 20px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 20px;">
                        <i class="fas fa-copy"></i> COPIAR CÓDIGO
                    </button>

                    <hr style="border-color: #333;">
                    
                    <p style="font-size: 14px; color: #ccc;">Após pagar no banco, confirme abaixo:</p>
                    <button onclick="confirmarPagamento()" class="btn-compre-agora" style="width: 100%; background-color: #00bd20;">
                        JÁ FIZ O PAGAMENTO
                    </button>
                </div>

            </div>
        </section>
    </main>

    <script>
        const selectQtd = document.getElementById('qtd');
        const totalDisplay = document.getElementById('totalDisplay');
        const precoUnitario = 50;
        let dadosCompra = {}; 

        selectQtd.addEventListener('change', () => {
            let total = selectQtd.value * precoUnitario;
            totalDisplay.innerText = `Total: R$ ${total},00`;
        });

        async function gerarPix() {
            const user = firebase.auth().currentUser;
            if (!user) {
                sessionStorage.setItem('voltarParaCheckout', 'true');
                window.location.href = "/login";
                return;
            }

            // PEGA OS DADOS DOS INPUTS
            const nome = document.getElementById('nome_pagador').value;
            const sobrenome = document.getElementById('sobrenome_pagador').value;
            const cpf = document.getElementById('cpf_pagador').value.replace(/\D/g, ''); // Remove pontos e traços

            // VALIDAÇÃO BÁSICA
            if (!nome || !sobrenome || cpf.length !== 11) {
                alert("Por favor, preencha seu Nome, Sobrenome e um CPF válido (11 números).");
                return;
            }

            const qtd = parseInt(selectQtd.value);
            const total = qtd * precoUnitario;

            document.getElementById('btn-pagar').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('msgErro').style.display = 'none';

            try {
                // ENVIA TUDO PARA O PYTHON
                const response = await fetch('/processar_pagamento', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: user.email,
                        valor: total,
                        descricao: `Festa 0800 - ${qtd}x Ingressos`,
                        nome: nome,          // NOVO
                        sobrenome: sobrenome,// NOVO
                        cpf: cpf             // NOVO
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.erro || `Erro HTTP: ${response.status}`);
                }

                const data = await response.json();

                if (data.qr_code) {
                    mostrarAreaPix(data, qtd, total, user);
                } else {
                    throw new Error("Resposta inválida do servidor");
                }

            } catch (error) {
                console.error("Erro:", error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('btn-pagar').style.display = 'block';
                document.getElementById('msgErro').style.display = 'block';
                document.getElementById('msgErro').innerText = "Erro: " + error.message;
            }
        }

        function mostrarAreaPix(dataMP, qtd, total, user) {
            document.getElementById('card-resumo').style.display = 'none';
            document.getElementById('card-pix').style.display = 'block';
            document.getElementById('cola-pix').value = dataMP.qr_code;

            dadosCompra = {
                uid_usuario: user.uid,
                email_usuario: user.email,
                evento: "Festa 0800",
                quantidade: qtd,
                valor: total,
                id_pagamento_mp: dataMP.id_pagamento, 
                status: "pendente", 
                data: new Date()
            };
        }

        function confirmarPagamento() {
            dadosCompra.status = "aprovado"; 
            db.collection("compras").add(dadosCompra)
            .then(() => {
                window.location.href = "/comprasucesso";
            })
            .catch((error) => {
                console.error("Erro ao salvar:", error);
                alert("Erro ao salvar ingresso no sistema.");
            });
        }

        function copiarPix() {
            const copyText = document.getElementById("cola-pix");
            copyText.select();
            document.execCommand("copy");
            const btn = document.querySelector("button[onclick='copiarPix()']");
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = "<i class='fas fa-check'></i> COPIADO!";
            setTimeout(() => { btn.innerHTML = textoOriginal; }, 2000);
        }
    </script>
</body>
</html>